{% extends "base.html" %}

{% block header %}Search Items{% endblock %}

{% block content %}
<div class="search-container">
    <div class="settings-form">
        <!-- <div class="form-group">
            <label for="name-selection">Name</label>
            <select id="name-selection" class="name-dropdown">
                <option value="">All Names</option>
                {% for name in names %}
                <option value="{{ name }}">{{ name }}</option>
                {% endfor %}
            </select>
        </div> -->

        <!-- <div class="form-group">
            <label for="rarity-selection">Rarity</label>
            <select id="rarity-selection" class="rarity-dropdown">
                <option value="">All Rarities</option>
                <option value="0">None</option>
                <option value="0">Poor</option>
                <option value="0">Common</option>
                <option value="1">Uncommon</option>
                <option value="2">Rare</option>
                <option value="3">Epic</option>
                <option value="4">Legend</option>
                <option value="1">Unique</option>
                <option value="5">Artifact</option>
            </select>
        </div> -->
        
    <!-- <h2>Rarity</h2>
    <select id="rarity-selection" class="rarity-dropdown">
        <option value="">All Rarities</option>
        <option value="0">None</option>
        <option value="0">Poor</option>
        <option value="0">Common</option>
        <option value="1">Uncommon</option>
        <option value="2">Rare</option>
        <option value="3">Epic</option>
        <option value="4">Legend</option>
        <option value="1">Unique</option>
        <option value="5">Artifact</option>
    </select>

    <h2>Enchantments</h2>
    <div id="sp-container">No rarity selected.</div>
    <br><br>

    <input type="text" class="search-input" placeholder="Search for items across all characters..." id="searchInput"> -->

        <!-- <div class="form-group">
            <label for="sp-container">Enchantments</label>
            <div id="sp-container">No rarity selected.</div>
        </div> -->
        <h2>Search</h2>
        <div class="instructions-panel">
            <h3>Instructions</h3>
            <ol>
                <li>Capture the characters whose stashes you want to search, you can check captured characters in the Characters section.</li>
                <li>Enter keywords separated by commas.</li>
                <li>When a similar item is found, it will appear in the list.</li>                
            </ol>
            <h3>Example</h3>
            <div class="form-group">
                <input type="text" class="settings-input" 
                       value="barbuta helm, rare, agility" 
                       readonly>
            </div>            
        </div>

        <div class="form-group">
            <input type="text" class="settings-input" placeholder="Search for items across all characters..."
                id="searchInput">
        </div>
    </div>

    <div class="search-results" id="searchResults"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let searchTimeout;

    const debounce = (func, wait) => {
        return (...args) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => func(...args), wait);
        };
    };

    function formatDataAsHTML(data, indent = 0) {
        const spacer = '&nbsp;'.repeat(indent * 4); // indentation
        let html = '';

        if (Array.isArray(data)) {
            html += '[<br>';
            html += data.map(item => `${spacer}&nbsp;&nbsp;${formatDataAsHTML(item, indent + 1)}`).join(',<br>');
            html += `<br>${spacer}]`;
        } else if (typeof data === 'object' && data !== null) {
            html += '{<br>';
            const entries = Object.entries(data);
            html += entries.map(([key, val]) => {
                return `${spacer}&nbsp;&nbsp;<strong>${key}</strong>: ${formatDataAsHTML(val, indent + 1)}`;
            }).join(',<br>');
            html += `<br>${spacer}}`;
        } else {
            html += String(data); // handles numbers, booleans, strings, null, undefined
        }

        return html;
    }


    const displayResults = (results) => {
        const container = document.getElementById('searchResults');
        container.innerHTML = '';

        if (results.length === 0) {
            container.innerHTML = '<div class="loading">No items found</div>';
            return;
        }
        // {'name': 'CastillonDagger', 'slotId': 11, 'itemId': 'DesignDataItem:Id_Item_CastillonDagger_4001', 'itemCount': 1}
        results.forEach(result => {
            console.log(result)
            const item = document.createElement('div');
            item.className = 'result-item';
            item.innerHTML = `
            <div class="character-name">${result.nickname} ${result.class} LvL ${result.level} Slot: ${result.item.slotId}</div>
            <div class="character-info">
                <div>${result.item.name}</div>
                <div>${result.item.rarity}</div>
                <div>${result.item.itemCount}</div>
            </div>
            <div class="item-popup">
                <div>${formatDataAsHTML(result.item.data)}</div>
            </div>
        `;

            item.onclick = () => window.location.href = `/character/${result.id}`;
            // TODO /api/character/<character_id>/stashes/<stash> ?

            container.appendChild(item);
        });
    };

    window.addEventListener('load', () => {
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');

        const performSearch = async (query) => {
            searchResults.innerHTML = '<div class="loading">Searching...</div>';

            try {
                if (window.pywebview && window.pywebview.api) {
                    details = await window.pywebview.api.search_items(query);
                } else {
                    const res = await fetch(`/api/search_items?query=${encodeURIComponent(query)}`);
                    details = await res.json();
                }

                displayResults(details);

            } catch (error) {
                searchResults.innerHTML = '<div class="loading">Error searching items. Please try again.</div>';
                console.log(error)
            }
        };

        searchInput.addEventListener('input', (e) => performSearch(e.target.value));
        //document.getElementById('name-selection').addEventListener('change', performSearch);
        // document.getElementById('rarity-selection').addEventListener('change', performSearch);
        // spContainer.addEventListener('change', performSearch);
        performSearch('')
    });
</script>
{% endblock %}