{% extends "base.html" %}

{% block header %}Search Items{% endblock %}

{% block content %}
<div class="search-container">
    <div class="settings-form">
        <!-- <div class="form-group">
            <label for="name-selection">Name</label>
            <select id="name-selection" class="name-dropdown">
                <option value="">All Names</option>
                {% for name in names %}
                <option value="{{ name }}">{{ name }}</option>
                {% endfor %}
            </select>
        </div> -->

        <!-- <div class="form-group">
            <label for="rarity-selection">Rarity</label>
            <select id="rarity-selection" class="rarity-dropdown">
                <option value="">All Rarities</option>
                <option value="0">None</option>
                <option value="0">Poor</option>
                <option value="0">Common</option>
                <option value="1">Uncommon</option>
                <option value="2">Rare</option>
                <option value="3">Epic</option>
                <option value="4">Legend</option>
                <option value="1">Unique</option>
                <option value="5">Artifact</option>
            </select>
        </div> -->

        <!-- <h2>Rarity</h2>
    <select id="rarity-selection" class="rarity-dropdown">
        <option value="">All Rarities</option>
        <option value="0">None</option>
        <option value="0">Poor</option>
        <option value="0">Common</option>
        <option value="1">Uncommon</option>
        <option value="2">Rare</option>
        <option value="3">Epic</option>
        <option value="4">Legend</option>
        <option value="1">Unique</option>
        <option value="5">Artifact</option>
    </select>

    <h2>Enchantments</h2>
    <div id="sp-container">No rarity selected.</div>
    <br><br>

    <input type="text" class="search-input" placeholder="Search for items across all characters..." id="searchInput"> -->

        <!-- <div class="form-group">
            <label for="sp-container">Enchantments</label>
            <div id="sp-container">No rarity selected.</div>
        </div> -->
        <h2>Search</h2>
        <div class="instructions-panel">
            <h3>Instructions</h3>
            <ol>
                <li>Capture the characters whose stashes you want to search, you can check captured characters in the
                    Characters section.</li>
                <li>Enter keywords separated by commas.</li>
                <li>When a similar item is found, it will appear in the list.</li>
            </ol>
            <h3>Example</h3>
            <div class="form-group">
                <input type="text" class="settings-input" value="barbuta helm, rare, agility" readonly>
            </div>
        </div>

        <div class="form-group">
            <input type="text" class="settings-input" placeholder="Search for items across all characters..."
                id="searchInput">
        </div>
    </div>

    <div class="search-results" id="searchResults"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let searchTimeout;

    const debounce = (func, wait) => {
        return (...args) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => func(...args), wait);
        };
    };

    function formatPrimaryProps(ppArray) {
        return ppArray.map(([name, value]) => `<div>${name} ${value}</div>`).join('');
    }

    function formatSecondaryProps(spArray) {
        return spArray.map(([name, value]) => {
            const sign = value >= 0 ? '+' : '';
            return `<div>${sign}${value} ${name}</div>`;
        }).join('');
    }

    const rarityColors = {
        Poor: '#555555',       // Dark grey
        Common: '#ffffff',     // White
        Uncommon: '#1eff00',   // Green
        Rare: '#0070dd',       // Blue
        Epic: '#a335ee',       // Purple
        Legend: '#ff8000',     // Orange
        Unique: '#ffff99',     // Yellow-white
        Artifact: '#ff2020'    // Red
    };

    const displayResults = (results) => {
        const container = document.getElementById('searchResults');
        container.innerHTML = '';

        if (results.length === 0) {
            container.innerHTML = '<div class="loading">No items found</div>';
            return;
        }

        results.forEach(result => {
            const item = document.createElement('div');
            item.className = 'result-item';
            const rarityColor = rarityColors[result.item.rarity] || '#ffffff';

            item.innerHTML = `
                <div class="character-name">${result.nickname} ${result.class} LvL ${result.level} Slot: ${result.slotId}</div>
                <div class="character-info">
                    <div>${result.item.name}</div>
                    <div>${result.item.rarity}</div>
                    <div>${result.itemCount}</div>
                </div>
                <div class="item-popup" style="position: absolute; display: none; z-index: 100; pointer-events: none;">
                    <div class="item-header" style="background-color: ${rarityColor}; color: #000;">${result.item.name}</div>
                    <div class="item-properties">
                        <div class="primary-props">${formatPrimaryProps(result.item.pp)}</div>
                        <div class="secondary-props">${formatSecondaryProps(result.item.sp)}</div>
                    </div>
                    <div class="item-meta">
                        <div>Rarity: ${result.item.rarity}</div>
                        <div>Count: ${result.itemCount}</div>
                    </div>
                </div>
            `;

            // Add event listeners for mouse interactions
            const popup = item.querySelector('.item-popup');

            item.addEventListener('mouseenter', (e) => {
                popup.style.display = 'block';
            });

            item.addEventListener('mousemove', (e) => {
                // Only move the tooltip within the item box area
                const offsetX = 15;
                const offsetY = 15;

                // Get bounding rect of the item box
                const rect = item.getBoundingClientRect();

                // Mouse position relative to viewport
                let left = e.clientX + offsetX;
                let top = e.clientY + offsetY;

                // Get viewport dimensions
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;

                // Get tooltip dimensions
                const tooltipWidth = popup.offsetWidth;
                const tooltipHeight = popup.offsetHeight;

                // Adjust if tooltip would go beyond right edge
                if (left + tooltipWidth > viewportWidth) {
                    left = e.clientX - tooltipWidth - offsetX;
                }

                // Adjust if tooltip would go beyond bottom edge
                if (top + tooltipHeight > viewportHeight) {
                    top = e.clientY - tooltipHeight - offsetY;
                }

                // Ensure tooltip doesn't go beyond left or top edges
                left = Math.max(0, left);
                top = Math.max(0, top);

                popup.style.left = `${left - rect.left}px`;
                popup.style.top = `${top - rect.top}px`;
            });

            item.addEventListener('mouseleave', () => {
                popup.style.display = 'none';
            });

            item.onclick = () => {
                fetch(`/api/character/${result.id}/current-stash/${result.stash_id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                // TODO not working as intended
                window.location.href = `/character/${result.id}`;
            };

            // Set item to relative positioning so tooltip is positioned within it
            item.style.position = 'relative';

            container.appendChild(item);
        });
    };

    window.addEventListener('load', () => {
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');

        const performSearch = async (query) => {
            searchResults.innerHTML = '<div class="loading">Searching...</div>';

            try {
                if (window.pywebview && window.pywebview.api) {
                    details = await window.pywebview.api.search_items(query);
                } else {
                    const res = await fetch(`/api/search_items?query=${encodeURIComponent(query)}`);
                    details = await res.json();
                }

                displayResults(details);

            } catch (error) {
                searchResults.innerHTML = '<div class="loading">Error searching items. Please try again.</div>';
                console.log(error)
            }
        };

        searchInput.addEventListener('input', (e) => performSearch(e.target.value));
        //document.getElementById('name-selection').addEventListener('change', performSearch);
        // document.getElementById('rarity-selection').addEventListener('change', performSearch);
        // spContainer.addEventListener('change', performSearch);
        performSearch('')
    });
</script>
{% endblock %}