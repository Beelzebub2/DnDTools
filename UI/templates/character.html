{% extends "base.html" %}

{% block header %}
<style>
    .stash-preview {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
    }

    .stash-preview-image {
        max-width: 100%;
        height: auto;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
</style>
<span id="characterHeader">Character Details</span>
{% endblock %}

{% block content %}
<div class="character-details">
    <div id="characterInfo" class="character-header">
        <div class="loading">Loading character details...</div>
    </div>
    <div class="stash-container">
        <!-- loading spinner -->
        <div id="stashSpinner" class="spinner"></div>
        <!-- stash parts hidden until loaded -->
        <div id="stashSelector" class="stash-tabs hidden"></div>
        <div id="stashPreview" class="stash-preview hidden">
            <img id="currentStashPreview" class="stash-preview-image" src="" alt="Stash Preview">
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const charId = window.location.pathname.split('/').pop();

    // Fetch character details via pywebview API or HTTP fallback
    const updateCharacterInfo = async (characterId) => {
        const charInfo = document.getElementById('characterInfo');
        const charHeader = document.getElementById('characterHeader');
        try {
            let details;
            if (window.pywebview && window.pywebview.api) {
                details = await window.pywebview.api.get_character_details(characterId);
            } else {
                const res = await fetch(`/api/character/${characterId}/details`);
                details = await res.json();
            }
            charHeader.textContent = details.nickname;
            charInfo.innerHTML = `
            <div class="char-info-grid">
                <div class="char-info-item">
                    <h1 class="character-name">${details.nickname}</h1>
                    <div class="character-subtitle">Level ${details.level} ${details.class}</div>
                </div>
                <div class="char-info-item">
                    <div class="info-label">Total Items</div>
                    <div class="info-value">${details.totalItems}</div>
                </div>
                <div class="char-info-item">
                    <div class="info-label">Stash Count</div>
                    <div class="info-value">${details.stashCount}</div>
                </div>
                <div class="char-info-item">
                    <div class="info-label">Last Updated</div>
                    <div class="info-value">${formatDate(details.lastUpdate)}</div>
                </div>
            </div>
        `;
        } catch (error) {
            handleApiError(error, charInfo);
        }
    };

    const createStashTabs = (stashes) => {
        const selector = document.getElementById('stashSelector');
        const preview = document.getElementById('currentStashPreview');
        selector.innerHTML = '';

        // Ensure stashes is an object
        const stashesObj = stashes || {};
        const stashKeys = Object.keys(stashesObj);
        let firstStashUrl = null;

        stashKeys.forEach((stashId, index) => {
            const tab = document.createElement('div');
            tab.className = 'stash-tab';
            if (index === 0) {
                tab.classList.add('active');
                // Store the first URL but don't set it yet
                firstStashUrl = stashes[stashId];
            }
            tab.textContent = `Stash ${index + 1}`;
            tab.dataset.stashId = stashId;
            tab.onclick = () => {
                document.querySelectorAll('.stash-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                preview.src = stashes[stashId]; // Set src on click
            };
            selector.appendChild(tab);
        });

        // Return the URL of the first stash to be loaded initially
        return firstStashUrl;
    };

    const loadStashes = async () => {
        const spinner = document.getElementById('stashSpinner');
        const selector = document.getElementById('stashSelector');
        const previewContainer = document.getElementById('stashPreview');
        const previewImage = document.getElementById('currentStashPreview'); // Get the image element

        // show spinner, hide stash content
        spinner.classList.remove('hidden');
        selector.classList.add('hidden');
        previewContainer.classList.add('hidden');
        previewImage.src = ""; // Ensure src is empty while hidden

        try {
            const response = await fetch(`/api/character/${charId}/stashes`);
            const stashes = await response.json();

            // Check if we have any stashes
            const stashKeys = Object.keys(stashes || {});
            if (stashKeys.length > 0) {
                const firstStashUrl = createStashTabs(stashes);
                // Set the src only after making the container visible
                if (firstStashUrl) {
                    previewImage.src = firstStashUrl;
                }
                // hide spinner, show stash content
                selector.classList.remove('hidden');
                previewContainer.classList.remove('hidden');
            } else {
                // Show empty state
                previewContainer.innerHTML = '<div class="empty-state">No stashes found for this character</div>';
                previewContainer.classList.remove('hidden');
            }
            spinner.classList.add('hidden');
        } catch (error) {
            handleApiError(error, document.getElementById('stashContainer'));
            spinner.classList.add('hidden');
        }
    };

    // Initialize page when DOM is loaded
    window.addEventListener('DOMContentLoaded', async () => {
        try {
            await updateCharacterInfo(charId);
            await loadStashes();
        } catch (error) {
            handleApiError(error, document.querySelector('.character-details'));
        }
    });
</script>
{% endblock %}